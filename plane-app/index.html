<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Perspective Plane — Commons↔Commerce × Club↔Crown</title>
<style>
:root{--bg:#0b0f14;--panel:#121821;--ink:#e6edf3;--muted:#9fb0c3;--accent:#82cfff}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial}
h1{font-size:18px;margin:12px 0} h2{font-size:16px;margin:10px 0}
.wrap{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,.35)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
label{color:var(--muted)} input[type="range"]{width:120px}
.small{font-size:12px;color:var(--muted)}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #233043;padding:3px 8px;border-radius:999px}
.sw{display:inline-flex;gap:8px;align-items:center;margin:6px 0}
button,select{background:#1a2432;color:var(--ink);border:1px solid #2a3a51;border-radius:8px;padding:6px 10px;cursor:pointer}
button:hover{border-color:#3c567a} canvas{background:#0b0f14;border-radius:12px}
.gridlab{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:4px}
.explain{white-space:pre-wrap;background:#0d1219;border:1px solid #213046;border-radius:10px;padding:10px;max-height:240px;overflow:auto}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}.hr{height:1px;background:#233043;margin:10px 0}
.kbd{font:12px ui-monospace,Menlo,Consolas;background:#0d1219;border:1px solid #213046;padding:1px 6px;border-radius:6px;color:#c7d6ea}
</style></head><body>
<div class="wrap">
  <div class="card">
    <h1>Perspective Plane</h1>
    <div class="small">Canon axes: <b>X = Commons → Commerce</b>, <b>Y = Club → Crown</b>. Weight domains; click a point to see why it’s there.</div>
    <div class="hr"></div>
    <h2>Domain weights</h2><div id="domains"></div>
    <div class="row"><label>Total = <span id="wTotal">0</span></label><button id="equalize">Equalize</button><button id="resetW">Reset</button></div>
    <div class="hr"></div>
    <h2>View & options</h2>
    <div class="row">
      <label class="sw"><input type="checkbox" id="flipX"> Flip X</label>
      <label class="sw"><input type="checkbox" id="flipY"> Flip Y</label>
      <label class="sw"><input type="checkbox" id="swapXY"> Swap axes</label>
    </div>
    <div class="row">
      <label class="sw"><input type="checkbox" id="trail"> Show trails</label>
      <label class="sw"><input type="checkbox" id="error"> Show error bars</label>
    </div>
    <div class="hr"></div>
    <h2>Entities</h2><div class="legend" id="legend"></div>
    <div class="row"><button id="toggleCountries">Toggle countries</button><button id="toggleParties">Toggle US parties</button><button id="toggleModes">Toggle CoCivium modes</button></div>
    <div class="small">Tip: hold <span class="kbd">Shift</span> while clicking canvas to pin explanations.</div>
  </div>
  <div class="card">
    <canvas id="plane" width="1000" height="700"></canvas>
    <div class="gridlab"><span>← Commons</span><span>Commerce →</span></div>
    <div class="gridlab" style="justify-content:center;margin-top:-18px;"><span>↑ Crown</span><span style="margin-left:16px">↓ Club</span></div>
    <div class="hr"></div><h2>Explanation</h2><div class="explain mono" id="explain">Click a point to see per-domain contributions and notes.</div>
  </div>
</div>
<script>
Promise.all([fetch('data/registry.json').then(r=>r.json()), fetch('data/entities.json').then(r=>r.json())]).then(([REG, ENT])=>{
  const DOMAIN_SPEC = REG.domains.map(d=>({id:d.id, name:d.name}));
  let domainWeights = {}; REG.domains.forEach(d=>domainWeights[d.id]=d.weight);
  const ENTITIES = ENT.entities; window.show = {countries:true, parties:true, modes:true};

  function weightedPoint(entity, weights){let s=0,x=0,y=0,parts=[];for(const d of DOMAIN_SPEC){const w=weights[d.id]||0; if(!entity.coords[d.id]) continue; const [dx,dy]=entity.coords[d.id]; x+=dx*w;y+=dy*w;s+=w;parts.push({domain:d.name,w,x:dx,y:dy});} return s?{x:x/s,y:y/s,parts,sumW:s}:{x:.5,y:.5,parts,sumW:0};}
  function transform(pt){let{x,y}=pt; if(flipX.checked)x=1-x; if(flipY.checked)y=1-y; if(swapXY.checked){const t=x;x=y;y=t;} return {x,y};}
  const PAL={grid:'#233043',axes:'#3c567a'};

  const c=document.getElementById('plane'),ctx=c.getContext('2d'); const W=c.width,H=c.height,P=70; const trail={};

  function draw(){
    ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(P,P); const w=W-2*P,h=H-2*P;
    ctx.strokeStyle=PAL.grid; ctx.lineWidth=1; for(let i=0;i<=10;i++){const x=(i/10)*w,y=(i/10)*h; ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke(); ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
    ctx.strokeStyle=PAL.axes; ctx.lineWidth=2; ctx.beginPath();ctx.moveTo(w/2,0);ctx.lineTo(w/2,h);ctx.stroke(); ctx.beginPath();ctx.moveTo(0,h/2);ctx.lineTo(w,h/2);ctx.stroke();

    ENTITIES.forEach(e=>{
      if(e.group==='country'&&!vis.countries) return; if(e.group==='party'&&!vis.parties) return; if(e.group==='mode'&&!vis.modes) return;
      const wp=weightedPoint(e,domainWeights), tp=transform(wp); const x=P+tp.x*w, y=P+tp.y*h;
      if(showTrail.checked){const arr=trail[e.id]=(trail[e.id]||[]); arr.push({x,y}); while(arr.length>60) arr.shift(); ctx.strokeStyle=e.color||'#fff'; ctx.globalAlpha=.18; ctx.lineWidth=3; ctx.beginPath(); for(let i=0;i<arr.length;i++){const p=arr[i]; if(i===0) ctx.moveTo(p.x-P,p.y-P); else ctx.lineTo(p.x-P,p.y-P);} ctx.stroke(); ctx.globalAlpha=1;}
      if(showErr.checked){const ex=.03*w,ey=.03*h; ctx.strokeStyle='#6c7788'; ctx.lineWidth=1.5; ctx.beginPath();ctx.moveTo(x-ex,y);ctx.lineTo(x+ex,y);ctx.stroke(); ctx.beginPath();ctx.moveTo(x,y-ey);ctx.lineTo(x,y+ey);ctx.stroke();}
      ctx.fillStyle=e.color||'#fff'; ctx.beginPath(); ctx.arc(x,y,6,0,2*Math.PI); ctx.fill();
      ctx.fillStyle='#cfe3ff'; ctx.font='12px system-ui'; ctx.fillText(e.label, x+8, y-8);
    });
    ctx.restore(); buildLegend();
  }

  function buildLegend(){const el=document.getElementById('legend'); el.innerHTML=''; ENTITIES.forEach(e=>{ if(e.group==='country'&&!vis.countries) return; if(e.group==='party'&&!vis.parties) return; if(e.group==='mode'&&!vis.modes) return; const d=document.createElement('div'); d.className='pill'; d.innerHTML=`<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${e.color}"></span>${e.label}`; el.appendChild(d); });}

  function setupDomains(){const box=document.getElementById('domains'); box.innerHTML=''; REG.domains.forEach(d=>{const row=document.createElement('div'); row.className='row'; const v=Math.round((domainWeights[d.id]||0)*100); row.innerHTML=`<label style="width:170px">${d.name}</label><input type="range" min="0" max="100" value="${v}" id="w_${d.id}"><span id="wval_${d.id}">${v}</span>%`; box.appendChild(row); row.querySelector('input').addEventListener('input',ev=>{domainWeights[d.id]=+ev.target.value/100; normalize(); draw(); total();});}); normalize(); total();}
  function normalize(){let s=0; REG.domains.forEach(d=>s+=(domainWeights[d.id]||0)); if(!s){const eq=1/REG.domains.length; REG.domains.forEach(d=>domainWeights[d.id]=eq); s=1;} REG.domains.forEach(d=>domainWeights[d.id]/=s); REG.domains.forEach(d=>{const v=Math.round((domainWeights[d.id]||0)*100); const inp=document.getElementById('w_'+d.id), out=document.getElementById('wval_'+d.id); if(inp) inp.value=v; if(out) out.textContent=v;});}
  function total(){let s=0; REG.domains.forEach(d=>s+=(domainWeights[d.id]||0)); document.getElementById('wTotal').textContent=(s*100).toFixed(0)+'% (normalized)';}

  const flipX=document.getElementById('flipX'),flipY=document.getElementById('flipY'),swapXY=document.getElementById('swapXY');
  const showTrail=document.getElementById('trail'),showErr=document.getElementById('error');
  flipX.onchange=flipY.onchange=swapXY.onchange=showTrail.onchange=showErr.onchange=draw;

  const vis=window.vis={countries:true, parties:true, modes:true};
  document.getElementById('toggleCountries').onclick=()=>{vis.countries=!vis.countries;draw();};
  document.getElementById('toggleParties').onclick=()=>{vis.parties=!vis.parties;draw();};
  document.getElementById('toggleModes').onclick=()=>{vis.modes=!vis.modes;draw();};

  document.getElementById('equalize').onclick=()=>{const eq=1/REG.domains.length; REG.domains.forEach(d=>domainWeights[d.id]=eq); normalize(); draw(); total();};
  document.getElementById('resetW').onclick=()=>{domainWeights={}; REG.domains.forEach(d=>domainWeights[d.id]=d.weight); normalize(); draw(); total();};

  const cEl=document.getElementById('plane');
  cEl.addEventListener('click',ev=>{
    const r=cEl.getBoundingClientRect(),x=ev.clientX-r.left,y=ev.clientY-r.top,w=cEl.width-2*P,h=cEl.height-2*P;
    let best=null,bd=1e9;
    ENTITIES.forEach(e=>{ if(e.group==='country'&&!vis.countries) return; if(e.group==='party'&&!vis.parties) return; if(e.group==='mode'&&!vis.modes) return;
      const raw=weightedPoint(e,domainWeights), tp=transform(raw), px=P+tp.x*w, py=P+tp.y*h, d2=(px-x)**2+(py-y)**2;
      if(d2<bd){bd=d2; best={e,raw,tp};}});
    if(!best) return;
    const lines=[]; lines.push(best.e.label);
    lines.push(`Position (view): X=${best.tp.x.toFixed(2)}  Y=${best.tp.y.toFixed(2)}  (canon X=${best.raw.x.toFixed(2)}, Y=${best.raw.y.toFixed(2)})`);
    lines.push('Contributors (domain → x,y × weight):');
    best.raw.parts.sort((a,b)=>b.w-a.w).forEach(p=>lines.push(` • ${p.domain.padEnd(18)} → (${p.x.toFixed(2)}, ${p.y.toFixed(2)}) × ${p.w.toFixed(2)}`));
    lines.push('Notes: '+(best.e.notes||'—'));
    const box=document.getElementById('explain'); if(ev.shiftKey){ box.textContent += "\n\n"+lines.join("\n"); } else { box.textContent = lines.join("\n"); }
  });

  (function loop(){ draw(); requestAnimationFrame(loop); })();
  setupDomains();
});
</script>
</body></html>