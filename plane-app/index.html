<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Perspective Plane — Commons↔Commerce × Club↔Crown</title>
<style>
:root{--bg:#0b0f14;--panel:#121821;--ink:#e6edf3;--muted:#9fb0c3;--accent:#82cfff}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial}
h1{font-size:18px;margin:12px 0} h2{font-size:16px;margin:10px 0}
.wrap{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,.35)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
label{color:var(--muted)} input[type="range"]{width:120px}
.small{font-size:12px;color:var(--muted)}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #233043;padding:3px 8px;border-radius:999px}
.sw{display:inline-flex;gap:8px;align-items:center;margin:6px 0}
button,select{background:#1a2432;color:var(--ink);border:1px solid #2a3a51;border-radius:8px;padding:6px 10px;cursor:pointer}
button:hover{border-color:#3c567a} canvas{background:#0b0f14;border-radius:12px}
.gridlab{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:4px}
.explain{white-space:pre-wrap;background:#0d1219;border:1px solid #213046;border-radius:10px;padding:10px;max-height:240px;overflow:auto}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}.hr{height:1px;background:#233043;margin:10px 0}
.kbd{font:12px ui-monospace,Menlo,Consolas;background:#0d1219;border:1px solid #213046;padding:1px 6px;border-radius:6px;color:#c7d6ea}
</style><style>
  :root{--cp-bg:#0b1220;--cp-card:#0f1623;--cp-border:#2a3b55;--cp-text:#e5f0ff;--cp-sub:#9fb7dd;--cp-accent:#0b3d91}
  .card{background:var(--cp-card);border:1px solid var(--cp-border);border-radius:14px;padding:16px;color:var(--cp-text);box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--cp-border);border-radius:999px;margin:4px;background:rgba(255,255,255,.03);font:13px/1.2 system-ui}
  .panel{display:grid;grid-template-columns:1fr;gap:12px}
  .row{display:grid;grid-template-columns:170px 1fr 48px;gap:8px;align-items:center}
  input[type="range"]{accent-color:var(--cp-accent)}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .toolbar label{display:flex;gap:6px;align-items:center;color:var(--cp-sub)}
  #explain{white-space:pre-wrap;font:13px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#0b1220;border:1px dashed #2a3b55;border-radius:12px;padding:12px;color:#cfe3ff}
  @media (max-width:720px){.row{grid-template-columns:130px 1fr 42px}.toolbar{flex-direction:column;align-items:flex-start}canvas#plane{max-width:100%;height:auto}}
</style>
</head><body>
<div class="wrap">
  <div class="card">
    <h1>Perspective Plane</h1>
    <div class="small">Canon axes: <b>X = Commons → Commerce</b>, <b>Y = Club → Crown</b>. Weight domains; click a point to see why it’s there.</div>
    <div class="hr"></div>
    <h2>Domain weights</h2><div id="domains"></div>
    <div class="row"><label>Total = <span id="wTotal">0</span></label><button id="equalize">Equalize</button><button id="resetW">Reset</button></div>
    <div class="hr"></div>
    <h2>View & options</h2>
    <div class="row">
      <label class="sw"><input type="checkbox" id="flipX"> Flip X</label>
      <label class="sw"><input type="checkbox" id="flipY"> Flip Y</label>
      <label class="sw"><input type="checkbox" id="swapXY"> Swap axes</label>
    </div>
    <div class="row">
      <label class="sw"><input type="checkbox" id="trail"> Show trails</label>
      <label class="sw"><input type="checkbox" id="error"> Show error bars</label>
    </div>
    <div class="hr"></div>
    <h2>Entities</h2><div class="legend" id="legend"></div>
    <div class="row"><button id="toggleCountries">Toggle countries</button><button id="toggleParties">Toggle US parties</button><button id="toggleModes">Toggle CoCivium modes</button></div>
    <div class="small">Tip: hold <span class="kbd">Shift</span> while clicking canvas to pin explanations.</div>
  </div>
  <div class="card">
    `<canvas id="plane" role="img" aria-label="Perspective Plane chart. X axis Commons to Commerce. Y axis Club to Crown." width="1000" height="700"></canvas>
    <div class="gridlab"><span>← Commons</span><span>Commerce →</span></div>
    <div class="gridlab" style="justify-content:center;margin-top:-18px;"><span>↑ Crown</span><span style="margin-left:16px">↓ Club</span></div>
    <div class="hr"></div><h2>Explanation</h2><div class="explain mono" id="explain">Click a point to see per-domain contributions and notes.</div>
  </div>
</div>
<script src="plane.js?v=1760936541" defer></script>

<script id="plane-boot-ensure">
(() => {
  const run = () => {
    try {
      // 1) ensure one visible group
      window.vis = window.vis || {};
      if (!(window.vis.countries || window.vis.parties || window.vis.modes)) {
        window.vis.modes = true;
      }
      // 2) equalize if total weights are 0
      if (typeof window.total === 'function' && typeof window.equalize === 'function') {
        try { const t = window.total(); if (!t || t === 0) window.equalize(); } catch {}
      }
      // 3) persist + draw
      try { window.encodeState && window.encodeState(); } catch {}
      try { window.draw && window.draw(); } catch {}
      // 4) show an explanation for first visible
      try {
        if (Array.isArray(window.ENTITIES) && typeof window.showExplainFor === 'function') {
          const e = window.ENTITIES.find(e =>
            (e.group === 'country' && window.vis.countries) ||
            (e.group === 'party'   && window.vis.parties)   ||
            (e.group === 'mode'    && window.vis.modes)
          );
          if (e) window.showExplainFor(e);
        }
      } catch {}
      try { window._planeDebug = { ENTITIES: window.ENTITIES, vis: window.vis, draw: window.draw, total: window.total }; } catch {}
    } catch (err) { try { window._planeError = err; } catch {} }
  };
  // run once DOM is ready, again after load (module timing)
  if (document.readyState !== 'loading') run();
  else document.addEventListener('DOMContentLoaded', run);
  window.addEventListener('load', () => { setTimeout(run, 50); setTimeout(run, 300); });
})();
</script><script id="wire-plane-buttons">
(()=>{ try{
  const safe = f => { try { return typeof f === 'function' ? f : null } catch { return null } };
  const api = {
    draw        : window.draw        || window.PLANE?.draw,
    total       : window.total       || window.PLANE?.total,
    equalize    : window.equalize    || window.PLANE?.equalize,
    encodeState : window.encodeState || window.PLANE?.encodeState,
  };
  const ensureVis = () => { window.vis = window.vis || { countries:false, parties:false, modes:false } };
  const qAll = s => Array.from(document.querySelectorAll(s));
  const findBtn = (txt) => qAll('button,input[type=button]').find(b => (b.textContent||b.value||'').toLowerCase().includes((txt||'').toLowerCase()));

  const wireOnce = () => {
    let wired = 0;

    const beq = findBtn('equalize');
    if (beq && !beq.__wired) { beq.__wired = true; wired++; beq.addEventListener('click', e => {
      e.preventDefault();
      try { if (safe(api.total) && safe(api.equalize)) api.equalize(); } catch {}
      try { safe(api.encodeState)?.(); } catch {}
      try { safe(api.draw)?.(); } catch {}
    }); }

    const brs = findBtn('reset');
    if (brs && !brs.__wired) { brs.__wired = true; wired++; brs.addEventListener('click', e => {
      e.preventDefault();
      try { qAll('input[type=range][name^=w-]').forEach(r=>{ r.value='0'; r.dispatchEvent(new Event('input',{bubbles:true})) }); } catch {}
      try { safe(api.encodeState)?.(); } catch {}
      try { safe(api.draw)?.(); } catch {}
    }); }

    const flip = key => { ensureVis(); window.vis[key] = !window.vis[key]; try { safe(api.encodeState)?.(); } catch {} try { safe(api.draw)?.(); } catch {} };

    const bc = findBtn('toggle countries'); if (bc && !bc.__wired) { bc.__wired = true; wired++; bc.addEventListener('click', e => { e.preventDefault(); flip('countries'); }); }
    const bp = findBtn('toggle us parties'); if (bp && !bp.__wired) { bp.__wired = true; wired++; bp.addEventListener('click', e => { e.preventDefault(); flip('parties');   }); }
    const bm = findBtn('toggle cocivium');   if (bm && !bm.__wired) { bm.__wired = true; wired++; bm.addEventListener('click', e => { e.preventDefault(); flip('modes');     }); }

    return wired;
  };

  const start = () => {
    let tries = 0; const t = setInterval(()=>{ const c=wireOnce(); if (c>0 || ++tries>50) clearInterval(t); },100);
  };
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start); else start();

  const mo = new MutationObserver(()=>wireOnce());
  mo.observe(document.body, { childList:true, subtree:true });
} catch(e){ try{ window._planeWireError=e }catch{} }})();
</script>
<script id="plane-rescue">
(()=>{ try{
  const drawFallback = () => {
    const c = document.querySelector('canvas'); if (!c) return;
    const rect = c.getBoundingClientRect(); const dpr = window.devicePixelRatio || 1;
    const w = Math.max(800, Math.round(rect.width  * dpr) || 800);
    const h = Math.max(520, Math.round(rect.height * dpr) || 520);
    c.width = w; c.height = h;
    const ctx = c.getContext('2d'); if (!ctx) return;
    // If app draw exists, let it handle
    if (typeof window.draw === 'function') { try { window.encodeState && window.encodeState(); window.draw(); return; } catch {} }
    // Otherwise render something visible
    const ents = Array.isArray(window.ENTITIES) ? window.ENTITIES.slice(0,24) : [];
    ctx.fillStyle = '#0e1726'; ctx.fillRect(0,0,w,h);
    const pts = ents.length
      ? ents.map((e,i)=>({x:(i+1)/(ents.length+1), y:0.3 + 0.4*((i*9301+49297)%10000)/10000}))
      : Array.from({length:9},(_,i)=>({x:(i%3+1)/4, y:(Math.floor(i/3)+1)/4}));
    ctx.fillStyle = '#87bdff';
    pts.forEach(p=>{ const x = 20 + p.x*(w-40); const y = 20 + p.y*(h-40); ctx.beginPath(); ctx.arc(x,y,3*dpr,0,Math.PI*2); ctx.fill(); });
    try { window._planeRescueRan = true; } catch {}
  };
  const boot = () => { try { drawFallback(); } catch(e){ try{ window._planeRescueErr=e }catch{} } };
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  window.addEventListener('load', ()=> setTimeout(boot, 60));
} catch(e){ try{ window._planeRescueErr=e }catch{} }})();
</script></body></html>